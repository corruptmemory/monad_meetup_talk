<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>RequestMonad.scala</title>
<style type="text/css">
<!--
body.hl	{ background-color:#1f1f1f; }
pre.hl	{ color:#dcdccc; background-color:#1f1f1f; font-size:10pt; font-family:'Cantarell';}
.hl.num { color:#dca3a3; font-weight:bold; }
.hl.esc { color:#dca3a3; font-weight:bold; }
.hl.str { color:#cc9393; }
.hl.pps { color:#cc9393; }
.hl.slc { color:#7f9f7f; font-style:italic; }
.hl.com { color:#7f9f7f; font-style:italic; }
.hl.ppc { color:#ffcfaf; font-weight:bold; }
.hl.opt { color:#dcdccc; }
.hl.lin { color:#9fafaf; }
.hl.kwa { color:#e3ceab; }
.hl.kwb { color:#dfdfbf; font-weight:bold; }
.hl.kwc { color:#aae3b2; }
.hl.kwd { color:#aabfe3; }
//-->
</style>
</head>
<body class="hl">
<pre class="hl"><span class="hl kwa">package</span> com<span class="hl opt">.</span>corruptmemory<span class="hl opt">.</span>monadic_web

<span class="hl kwa">abstract class</span> RequestMonad <span class="hl opt">{</span>
  self <span class="hl opt">=&gt;</span>
  <span class="hl kwa">import</span> MaybeError<span class="hl opt">.</span>MaybeError
  <span class="hl kwa">import</span> RequestMonad<span class="hl opt">.</span>_
  <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">:</span>Request<span class="hl opt">):</span>MaybeError
  <span class="hl kwa">def</span> <span class="hl kwd">map</span><span class="hl opt">(</span>f<span class="hl opt">:</span>MaybeError <span class="hl opt">=&gt;</span> MaybeError<span class="hl opt">):</span>RequestMonad <span class="hl opt">=</span> <span class="hl kwa">new</span> RequestMonad <span class="hl opt">{</span>
    <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">:</span>Request<span class="hl opt">):</span>MaybeError <span class="hl opt">=</span> 
      self<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">).</span><span class="hl kwd">fold</span><span class="hl opt">(</span>fa <span class="hl opt">=</span> l <span class="hl opt">=&gt;</span> <span class="hl kwd">Left</span><span class="hl opt">(</span>l<span class="hl opt">),</span>
                               fb <span class="hl opt">=</span> r <span class="hl opt">=&gt;</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwd">Right</span><span class="hl opt">(</span>r<span class="hl opt">)))</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">def</span> <span class="hl kwd">flatMap</span><span class="hl opt">(</span>f<span class="hl opt">:</span>MaybeError <span class="hl opt">=&gt;</span> RequestMonad<span class="hl opt">):</span>RequestMonad <span class="hl opt">=</span> <span class="hl kwa">new</span> RequestMonad <span class="hl opt">{</span>
    <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">:</span>Request<span class="hl opt">):</span>MaybeError <span class="hl opt">=</span> 
      self<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">).</span><span class="hl kwd">fold</span><span class="hl opt">(</span>fa <span class="hl opt">=</span> l <span class="hl opt">=&gt;</span> <span class="hl kwd">Left</span><span class="hl opt">(</span>l<span class="hl opt">),</span>
                               fb <span class="hl opt">=</span> r <span class="hl opt">=&gt;</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwd">Right</span><span class="hl opt">(</span>r<span class="hl opt">)).</span><span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">))</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">object</span> RequestMonad <span class="hl opt">{</span>
  <span class="hl kwa">import</span> MaybeError<span class="hl opt">.</span>MaybeError
  <span class="hl kwa">type</span> Request <span class="hl opt">=</span> Map<span class="hl opt">[</span>String<span class="hl opt">,</span>String<span class="hl opt">]</span>
  <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>handler<span class="hl opt">:</span>Request<span class="hl opt">=&gt;</span>MaybeError<span class="hl opt">):</span>RequestMonad <span class="hl opt">=</span> <span class="hl kwa">new</span> RequestMonad <span class="hl opt">{</span>
    <span class="hl kwa">import</span> MaybeError<span class="hl opt">.</span>MaybeError
    <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">:</span>Request<span class="hl opt">):</span>MaybeError <span class="hl opt">=</span> <span class="hl kwd">handler</span><span class="hl opt">(</span>request<span class="hl opt">)</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">def</span> <span class="hl kwd">wrapResponse</span><span class="hl opt">(</span>response<span class="hl opt">:</span>MaybeError<span class="hl opt">,</span>wrapper<span class="hl opt">:</span>Request<span class="hl opt">=&gt;</span>Response<span class="hl opt">=&gt;</span>MaybeError<span class="hl opt">):</span>RequestMonad <span class="hl opt">=</span> <span class="hl kwa">new</span> RequestMonad <span class="hl opt">{</span>
    <span class="hl kwa">import</span> MaybeError<span class="hl opt">.</span>MaybeError
    <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">:</span>Request<span class="hl opt">):</span>MaybeError <span class="hl opt">=</span> 
      response<span class="hl opt">.</span><span class="hl kwd">fold</span><span class="hl opt">(</span>fa <span class="hl opt">=</span> l <span class="hl opt">=&gt;</span> <span class="hl kwd">Left</span><span class="hl opt">(</span>l<span class="hl opt">),</span>
                    fb <span class="hl opt">=</span> r <span class="hl opt">=&gt;</span> <span class="hl kwd">wrapper</span><span class="hl opt">(</span>request<span class="hl opt">)(</span>r<span class="hl opt">))</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">abstract class</span> RequestReader<span class="hl opt">[</span>A<span class="hl opt">] {</span>
  self <span class="hl opt">=&gt;</span>
  <span class="hl kwa">import</span> RequestMonad<span class="hl opt">.</span>_
  <span class="hl kwa">import</span> RequestHelpers<span class="hl opt">.</span>_
  <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">:</span>Request<span class="hl opt">):</span>Result<span class="hl opt">[</span>A<span class="hl opt">]</span>
  
  <span class="hl kwa">def</span> map<span class="hl opt">[</span>B<span class="hl opt">](</span>f<span class="hl opt">:</span>A <span class="hl opt">=&gt;</span> B<span class="hl opt">):</span>RequestReader<span class="hl opt">[</span>B<span class="hl opt">] =</span> <span class="hl kwa">new</span> RequestReader<span class="hl opt">[</span>B<span class="hl opt">] {</span>
    <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">:</span>Request<span class="hl opt">):</span>Result<span class="hl opt">[</span>B<span class="hl opt">] =</span> 
      self<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">).</span><span class="hl kwd">fold</span><span class="hl opt">(</span>fa <span class="hl opt">=</span> l <span class="hl opt">=&gt;</span> <span class="hl kwd">Left</span><span class="hl opt">(</span>l<span class="hl opt">),</span>
                               fb <span class="hl opt">=</span> r <span class="hl opt">=&gt;</span> <span class="hl kwd">Right</span><span class="hl opt">(</span><span class="hl kwd">f</span><span class="hl opt">(</span>r<span class="hl opt">)))</span>
  <span class="hl opt">}</span>
  
  <span class="hl kwa">def</span> flatMap<span class="hl opt">[</span>B<span class="hl opt">](</span>f<span class="hl opt">:</span>A <span class="hl opt">=&gt;</span> RequestReader<span class="hl opt">[</span>B<span class="hl opt">]):</span>RequestReader<span class="hl opt">[</span>B<span class="hl opt">] =</span> <span class="hl kwa">new</span> RequestReader<span class="hl opt">[</span>B<span class="hl opt">] {</span>
    <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">:</span>Request<span class="hl opt">):</span>Result<span class="hl opt">[</span>B<span class="hl opt">] =</span> 
      self<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">).</span><span class="hl kwd">fold</span><span class="hl opt">(</span>fa <span class="hl opt">=</span> l <span class="hl opt">=&gt;</span> <span class="hl kwd">Left</span><span class="hl opt">(</span>l<span class="hl opt">),</span>
                               fb <span class="hl opt">=</span> r <span class="hl opt">=&gt;</span> <span class="hl kwd">f</span><span class="hl opt">(</span>r<span class="hl opt">).</span><span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">))</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl kwa">object</span> RequestHelpers <span class="hl opt">{</span>
  <span class="hl kwa">import</span> RequestMonad<span class="hl opt">.</span>_
  <span class="hl kwa">type</span> Result<span class="hl opt">[</span>X<span class="hl opt">] =</span> Either<span class="hl opt">[</span>String<span class="hl opt">,</span>X<span class="hl opt">]</span>
  <span class="hl kwa">def</span> <span class="hl kwd">read</span><span class="hl opt">(</span>key<span class="hl opt">:</span>String<span class="hl opt">):</span>RequestReader<span class="hl opt">[</span>String<span class="hl opt">] =</span> <span class="hl kwa">new</span> RequestReader<span class="hl opt">[</span>String<span class="hl opt">] {</span>
    <span class="hl kwa">def</span> <span class="hl kwd">apply</span><span class="hl opt">(</span>request<span class="hl opt">:</span>Request<span class="hl opt">):</span>Result<span class="hl opt">[</span>String<span class="hl opt">] =</span> request<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">(</span>key<span class="hl opt">)</span> match <span class="hl opt">{</span>
      <span class="hl kwa">case</span> <span class="hl kwd">Some</span><span class="hl opt">(</span>x<span class="hl opt">) =&gt;</span> <span class="hl kwd">Right</span><span class="hl opt">(</span>x<span class="hl opt">)</span>
      <span class="hl kwa">case</span> None <span class="hl opt">=&gt;</span> <span class="hl kwd">Left</span><span class="hl opt">(</span><span class="hl str">&quot;Could not get value for:%s&quot;</span><span class="hl opt">.</span><span class="hl kwd">format</span><span class="hl opt">(</span>key<span class="hl opt">))</span>
    <span class="hl opt">}</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>
</pre>
</body>
</html>
<!--HTML generated by highlight 3.4, http://www.andre-simon.de/-->
